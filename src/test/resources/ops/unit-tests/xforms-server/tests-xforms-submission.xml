<!--
  Copyright (C) 2010 Orbeon, Inc.

  This program is free software; you can redistribute it and/or modify it under the terms of the
  GNU Lesser General Public License as published by the Free Software Foundation; either version
  2.1 of the License, or (at your option) any later version.

  This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
  without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  See the GNU Lesser General Public License for more details.

  The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
  -->
<group description="XForms Submission" xmlns:p="http://www.orbeon.com/oxf/pipeline"
    xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xs="http://www.w3.org/2001/XMLSchema"
    xmlns:xh="http://www.w3.org/1999/xhtml"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xf="http://www.w3.org/2002/xforms"
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events"
    xmlns:xbl="http://www.w3.org/ns/xbl"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner">

    <test description="Instance replacement with index updates" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="main-model">
                        <xf:instance id="main-instance">
                            <instance>
                               <r1/>
                               <r1>
                                   <r2/>
                                   <r2/>
                               </r1>
                               <r1/>
                               <r3/>
                               <r4/>
                               <r4>
                                   <r5/>
                                   <r5/>
                               </r4>
                               <r4/>
                           </instance>
                        </xf:instance>
                        <xf:instance id="new-instance">
                           <instance>
                               <r1/>
                               <r1>
                                   <r2/><!-- Force repeat2 from 2 to 1 -->
                               </r1>
                               <r1/>
                               <!-- Force repeat3 from 1 to 0 -->
                               <r4>
                                   <r5/><!-- Force repeat5 from 0 to 1 -->
                               </r4>
                               <r4>
                                   <r5/>
                                   <r5/>
                               </r4>
                               <r4/>
                           </instance>
                        </xf:instance>
                        <xf:submission id="test-submission" ref="instance('new-instance')" action="echo:"
                                           replace="instance" instance="main-instance" method="post"/>

                        <xf:dispatch ev:event="xforms-ready" name="DOMActivate" targetid="test-trigger"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:repeat ref="r1" id="repeat1" startindex="2">
                        <xf:repeat ref="r2" id="repeat2" startindex="4">
                        </xf:repeat>
                    </xf:repeat>
                    <xf:repeat ref="r3" id="repeat3">
                    </xf:repeat>
                    <xf:repeat ref="r4" id="repeat4">
                        <xf:repeat ref="r5" id="repeat5"/>
                    </xf:repeat>
                    <xf:trigger id="test-trigger">
                        <xf:label>Test</xf:label>
                        <xf:send id="my-submission" submission="test-submission" ev:event="DOMActivate"/>
                    </xf:trigger>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <instance>
                                    <r1/>
                                    <r1>
                                        <r2/>
                                        <!-- Force repeat2 from 2 to 1 -->
                                    </r1>
                                    <r1/>
                                    <!-- Force repeat3 from 1 to 0 -->
                                    <r4>
                                        <r5/>
                                        <!-- Force repeat5 from 0 to 1 -->
                                    </r4>
                                    <r4>
                                        <r5/>
                                        <r5/>
                                    </r4>
                                    <r4/>
                                </instance>
                            </instance>
                        </instances>
                        <controls>
                            <control effective-id="repeat1" index="2"/>
                            <control effective-id="repeat2⊙2" index="1"/>
                            <control effective-id="repeat4" index="1"/>
                            <control effective-id="repeat5⊙1" index="1"/>
                            <control effective-id="repeat5⊙2" index="1"/>
                        </controls>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="test-trigger" label="Test"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Submitting required but empty values fails submission" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="main-model">
                        <xf:instance id="main-instance">
                            <instance xmlns="">
                                <required-but-emtpy-element/>
                                <other-element required-but-emtpy-attribute=""/>
                                <submission-serialized>false</submission-serialized>
                                <submission-result/>
                            </instance>
                        </xf:instance>

                        <xf:bind ref="required-but-emtpy-element" required="true()"/>
                        <xf:bind ref="other-element/@required-but-emtpy-attribute" required="true()"/>

                        <xf:submission id="test-submission" method="post" action="echo:" replace="instance">
                            <xf:setvalue ev:event="xforms-submit-error" ref="submission-result">error</xf:setvalue>
                            <xf:setvalue ev:event="xforms-submit-done" ref="submission-result">done</xf:setvalue>
                            <xf:setvalue ev:event="xforms-submit-serialize" ref="submission-serialized">true</xf:setvalue>
                        </xf:submission>
                        <xf:send ev:event="xforms-ready" submission="test-submission"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="main-instance" model-id="main-model">
                                <instance>
                                    <required-but-emtpy-element/>
                                    <other-element required-but-emtpy-attribute=""/>
                                    <submission-serialized>false</submission-serialized>
                                    <submission-result>error</submission-result>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement on xforms-ready with read-only instance properly updates controls" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model>
                        <xf:instance id="initial-instance">
                            <instance>
                                <value>1</value>
                            </instance>
                        </xf:instance>

                        <xf:instance id="new-instance" xxf:readonly="true">
                            <instance>
                                <value>2</value>
                            </instance>
                        </xf:instance>

                        <xf:submission id="replace-submission"
                                           ref="instance('new-instance')" method="post" resource="echo:"
                                           replace="instance" instance="initial-instance"
                                           xxf:readonly="true"/>

                        <!-- When this is called on xforms-ready, controls must update properly -->
                        <xf:send ev:event="xforms-ready" submission="replace-submission"/>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:input ref="value" id="my-input">
                        <xf:label>Value:</xf:label>
                    </xf:input>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
           <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance readonly="true" id="initial-instance" model-id="xf-1">
                                <instance>
                                    <value>2</value>
                                </instance>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-input" label="Value:" readonly="true">2</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="XInclude upon replacement of cached instance" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <!-- Instance with XInclude -->
                        <xf:instance id="instance-xinclude">
                            <dummy xmlns=""/>
                        </xf:instance>
                        <!-- Load instance upon init -->
                        <xf:send ev:event="xforms-model-construct-done" submission="get-instance-xinclude"/>
                        <xf:submission id="get-instance-xinclude" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/url-generator/included-1.xml"
                                replace="instance" instance="instance-xinclude" xxf:readonly="true" xxf:shared="application" xxf:xinclude="true"/>

                        <!-- Instance without XInclude -->
                        <xf:instance id="instance-no-xinclude">
                            <dummy xmlns=""/>
                        </xf:instance>
                        <!-- Load instance upon init -->
                        <xf:send ev:event="xforms-model-construct-done" submission="get-instance-no-xinclude"/>
                        <xf:submission id="get-instance-no-xinclude" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/url-generator/included-1.xml"
                                replace="instance" instance="instance-no-xinclude" xxf:readonly="true" xxf:cache="true" xxf:xinclude="false"/>
                    </xf:model>
                </xh:head>
                <xh:body>
                    <!-- The title is found under the XIncluded content and it must be readonly -->
                    <xf:output id="my-output-xinclude" ref="instance('instance-xinclude')//xh:title"/>

                    <xf:output id="my-output-no-xinclude" ref="instance('instance-no-xinclude')//xh:title"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance readonly="true" cache="true" id="instance-xinclude" model-id="model" source-uri="oxf:/ops/unit-tests/url-generator/included-1.xml" xinclude="true"/>
                            <instance readonly="true" cache="true" id="instance-no-xinclude" model-id="model" source-uri="oxf:/ops/unit-tests/url-generator/included-1.xml"/>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output-xinclude" readonly="true">Summary</xxf:control>
                        <xxf:control id="my-output-no-xinclude" relevant="false"/>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace submitted instance" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy xmlns=""/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('inserted-nodes', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="source-instance" inserted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace submitted instance using @targetref" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy xmlns=""/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="instance('source-instance')"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('inserted-nodes', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="source-instance" inserted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace subset of submitted instance using @targetref" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <books xmlns="">
                                <before/>
                                <here/>
                                <after/>
                            </books>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="instance('source-instance')/here"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('inserted-nodes', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <books>
                                    <before/>
                                    <book>
                                        <title lang="en">Pale Blue Dot</title>
                                        <author>Carl Sagan</author>
                                    </book>
                                    <after/>
                                </books>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="source-instance" inserted-nodes="book"/>
                                    <event type="xforms-delete" target="source-instance" deleted-nodes="here"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace other instance" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy xmlns=""/>
                        </xf:instance>

                        <xf:instance id="destination-instance">
                            <dummy xmlns=""/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" instance="destination-instance"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('inserted-nodes', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="destination-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="destination-instance" inserted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace other instance using @instance and @targetref" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy xmlns=""/>
                        </xf:instance>

                        <xf:instance id="destination-instance">
                            <dummy xmlns=""/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" instance="destination-instance" targetref="."/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('inserted-nodes', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="destination-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="destination-instance" inserted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace other instance using @targetref only" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy xmlns=""/>
                        </xf:instance>

                        <xf:instance id="destination-instance">
                            <dummy xmlns=""/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="instance('destination-instance')"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('inserted-nodes', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="destination-instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="destination-instance" inserted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace subset of other instance using @targetref only" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy xmlns=""/>
                        </xf:instance>

                        <xf:instance id="destination-instance">
                            <books>
                                <before/>
                                <here/>
                                <after/>
                            </books>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="instance('destination-instance')/here"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('inserted-nodes', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="destination-instance" model-id="model">
                                <books>
                                    <before/>
                                    <book>
                                        <title lang="en">Pale Blue Dot</title>
                                        <author>Carl Sagan</author>
                                    </book>
                                    <after/>
                                </books>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="destination-instance" inserted-nodes="book"/>
                                    <event type="xforms-delete" target="destination-instance" deleted-nodes="here"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: destination points to instance element node" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy xmlns="" foo="bar"/>
                        </xf:instance>

                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="replace-instance-1"/>
                            <xf:send submission="replace-instance-2"/>
                            <xf:send submission="replace-instance-3"/>
                        </xf:action>
                        <!-- Attribute node -->
                        <xf:submission id="replace-instance-1" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="/*/@bar"/>
                        <!-- Document node -->
                        <xf:submission id="replace-instance-2" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="/"/>
                        <!-- Non-instance element -->
                        <xf:submission id="replace-instance-3" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="xxf:element('foobar')"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                         <instances>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-submit-error" target="replace-instance-1" error-type="target-error"/>
                                    <event type="xforms-submit-error" target="replace-instance-2" error-type="target-error"/>
                                    <event type="xforms-submit-error" target="replace-instance-3" error-type="target-error"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace dispatches events for controls bound to replaced subset" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <books xmlns="">
                                <book/>
                                <book>
                                    <title lang="fr">Jacques le fataliste et son maître</title>
                                    <author>Diderot</author>
                                </book>
                            </books>
                        </xf:instance>

                        <xf:action ev:event="xforms-ready">
                            <!-- Refresh will cause UI events dispatch -->
                            <xf:refresh/>
                            <!-- Clear all events recorded so far -->
                            <xf:delete ref="instance('events')/*"/>
                            <!-- Start submission -->
                            <xf:send submission="replace-instance"/>
                        </xf:action>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="instance('source-instance')/book"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('inserted-nodes', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                    <xf:group id="group">
                        <xf:insert ev:event="#all"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('inserted-nodes', $c)
                                                 ))"/>

                        <!-- This must change -->
                        <xf:input id="title1" ref="book[1]/title"/>
                        <xf:input id="lang1" ref="book[1]/title/@lang"/>
                        <!-- This must not -->
                        <xf:input id="title2" ref="book[2]/title"/>
                        <xf:input id="lang2" ref="book[2]/title/@lang"/>
                    </xf:group>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <books>
                                    <book>
                                        <title lang="en">Pale Blue Dot</title>
                                        <author>Carl Sagan</author>
                                    </book>
                                    <book>
                                        <title lang="fr">Jacques le fataliste et son maître</title>
                                        <author>Diderot</author>
                                    </book>
                                </books>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-insert" target="source-instance" inserted-nodes="book"/>
                                    <event type="xforms-delete" target="source-instance" deleted-nodes="book"/>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                    <event type="xforms-enabled" target="title1"/>
                                    <event type="xforms-enabled" target="lang1"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="title1">Pale Blue Dot</xxf:control>
                        <xxf:control id="lang1">en</xxf:control>
                        <xxf:control id="title2">Jacques le fataliste et son maître</xxf:control>
                        <xxf:control id="lang2">fr</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: replace text" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <book xmlns=""/>
                        </xf:instance>

                        <xf:send ev:event="xforms-model-construct-done" submission="replace-instance"/>
                        <xf:submission id="replace-instance" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="text" targetref="instance('source-instance')"/>

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('inserted-nodes', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <book>&lt;book&gt;
    &lt;title lang="en"&gt;Pale Blue Dot&lt;/title&gt;
    &lt;author&gt;Carl Sagan&lt;/author&gt;
&lt;/book&gt;</book>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-submit-done" target="replace-instance"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Instance replacement: errors when using xxf:readonly and/or xxf:shared" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="source-instance">
                            <dummy xmlns="">
                                <nested-element/>
                            </dummy>
                        </xf:instance>

                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="replace-instance-1"/>
                            <xf:send submission="replace-instance-2"/>
                            <xf:send submission="replace-instance-3"/>
                        </xf:action>
                        <!-- xxf:readonly -->
                        <xf:submission id="replace-instance-1" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="/*/nested-element" xxf:readonly="true"/>
                        <!-- xxf:shared -->
                        <xf:submission id="replace-instance-2" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="/*/nested-element" xxf:readonly="true" xxf:shared="application"/>
                        <!-- Regular case -->
                        <xf:submission id="replace-instance-3" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml"
                                replace="instance" targetref="/*/nested-element" />

                        <!-- TEST: Events to gather -->
                        <xf:instance id="events">
                            <events/>
                        </xf:instance>
                        <xf:insert ev:event="xforms-insert xforms-delete" ev:target="source-instance destination-instance"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('inserted-nodes')[1] return xxf:attribute('inserted-nodes', name($c)),
                                                 for $c in event('deleted-nodes')[1] return xxf:attribute('deleted-nodes', name($c))
                                                 ))"/>
                        <xf:insert ev:event="xforms-submit-done xforms-submit-error"
                                       context="instance('events')" ref="*"
                                       origin="xxf:element('event',
                                                (xxf:attribute('type', event('xxf:type')),
                                                 xxf:attribute('target', event('xxf:targetid')),
                                                 for $c in event('error-type') return xxf:attribute('error-type', $c)
                                                 ))"/>

                    </xf:model>
                </xh:head>
                <xh:body>

                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="source-instance" model-id="model">
                                <dummy>
                                    <book>
                                        <title lang="en">Pale Blue Dot</title>
                                        <author>Carl Sagan</author>
                                    </book>
                                </dummy>
                            </instance>
                            <instance id="events" model-id="model">
                                <events>
                                    <event type="xforms-submit-error" target="replace-instance-1" error-type="target-error"/>
                                    <event type="xforms-submit-error" target="replace-instance-2" error-type="target-error"/>
                                    <event type="xforms-insert" target="source-instance" inserted-nodes="book"/>
                                    <event type="xforms-delete" target="source-instance" deleted-nodes="nested-element"/>
                                    <event type="xforms-submit-done" target="replace-instance-3"/>
                                </events>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Replacement of read-write cached instance keeps instances separate" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="instance-1">
                            <dummy xmlns=""/>
                        </xf:instance>
                        <xf:instance id="instance-2">
                            <dummy xmlns=""/>
                        </xf:instance>

                        <!-- Load instances upon init -->
                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="get-instance-1"/>
                            <xf:send submission="get-instance-2"/>
                        </xf:action>
                        <xf:submission id="get-instance-1" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/test-data/book-diderot.xml"
                                replace="instance" targetref="instance('instance-1')" xxf:readonly="false" xxf:cache="true">
                            <xf:setvalue ev:event="xforms-submit-done" ref="details/link">http://en.wikipedia.org/wiki/Jacques_le_fataliste_et_son_ma%C3%AEtre</xf:setvalue>
                        </xf:submission>
                        <xf:submission id="get-instance-2" method="get" serialization="none"
                                resource="oxf:/ops/unit-tests/test-data/book-diderot.xml"
                                replace="instance" targetref="instance('instance-2')" xxf:cache="true">
                            <xf:setvalue ev:event="xforms-submit-done" ref="instance('instance-2')/details/link">http://fr.wikipedia.org/wiki/Jacques_le_fataliste_et_son_ma%C3%AEtre</xf:setvalue>
                        </xf:submission>

                    </xf:model>
                </xh:head>
                <xh:body>
                    <xf:output id="my-output-1" ref="instance('instance-1')/details/link"/>
                    <xf:output id="my-output-2" ref="instance('instance-2')/details/link"/>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance cache="true" id="instance-1" model-id="model" source-uri="oxf:/ops/unit-tests/test-data/book-diderot.xml"/>
                            <instance cache="true" id="instance-2" model-id="model" source-uri="oxf:/ops/unit-tests/test-data/book-diderot.xml"/>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values>
                        <xxf:control id="my-output-1">http://en.wikipedia.org/wiki/Jacques_le_fataliste_et_son_ma%C3%AEtre</xxf:control>
                        <xxf:control id="my-output-2">http://fr.wikipedia.org/wiki/Jacques_le_fataliste_et_son_ma%C3%AEtre</xxf:control>
                    </xxf:control-values>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="xf:submission/@xxf:recalculate" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="request">
                            <request/>
                        </xf:instance>

                        <xf:instance id="response-calculate-norebuild">
                            <response/>
                        </xf:instance>

                        <xf:instance id="response-calculate-rebuild">
                            <response/>
                        </xf:instance>

                        <xf:instance id="response-nocalculate-norebuild1">
                            <response/>
                        </xf:instance>

                        <xf:instance id="response-nocalculate-norebuild2">
                            <response/>
                        </xf:instance>

                        <xf:instance id="template" xxf:readonly="true">
                            <request>
                                <value/>
                                <value/>
                                <position>1</position>
                                <source>42</source>
                            </request>
                        </xf:instance>

                        <xf:bind ref="instance()/value[position() = instance()/position]" calculate="instance()/source"/>

                        <!-- Run submissions upon init -->
                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="calculate-norebuild"/>
                            <xf:send submission="calculate-rebuild"/>
                            <xf:send submission="nocalculate-norebuild1"/>
                            <xf:send submission="nocalculate-norebuild2"/>
                            <!-- TODO: case of serialization="none" -->
                        </xf:action>

                        <xf:submission id="calculate-norebuild" ref="instance()" method="post" resource="echo:"
                                           replace="instance" instance="response-calculate-norebuild"
                                           validate="false" relevant="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state -->
                                <xf:insert ref="instance()" origin="instance('template')"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <xf:revalidate/>
                                <!-- setvalue: expecting just recalculate -->
                                <xf:setvalue ref="instance()/source">888</xf:setvalue>
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="calculate-rebuild" ref="instance()" method="post" resource="echo:"
                                           replace="instance" instance="response-calculate-rebuild"
                                           validate="false" relevant="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state but don't refresh -->
                                <xf:insert ref="instance()" origin="instance('template')"/>

                                <!-- Because of insert above, expecting: rebuild, recalculate -->
                                <xf:setvalue ref="instance()/source">888</xf:setvalue>
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="nocalculate-norebuild1" ref="instance()" method="post" resource="echo:"
                                           replace="instance" instance="response-nocalculate-norebuild1"
                                           validate="false" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state -->
                                <xf:insert ref="instance()" origin="instance('template')"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <xf:revalidate/>
                                <!-- NOT expecting rebuild or recalculate, binds point to new instance -->
                                <xf:setvalue ref="instance()/source">888</xf:setvalue>
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="nocalculate-norebuild2" ref="instance()" method="post" resource="echo:"
                                           replace="instance" instance="response-nocalculate-norebuild2"
                                           validate="false" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state but don't refresh -->
                                <xf:insert ref="instance()" origin="instance('template')"/>

                                <!-- NOT expecting rebuild or recalculate, and binds point to old instance -->
                                <xf:setvalue ref="instance()/source">888</xf:setvalue>
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                        </xf:submission>

                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="request" model-id="model">
                                <request>
                                    <value/>
                                    <value>888</value>
                                    <position>2</position>
                                    <source>888</source>
                                </request>
                            </instance>
                            <instance id="response-calculate-norebuild" model-id="model">
                                <request>
                                    <value>888</value>
                                    <value/>
                                    <position>2</position>
                                    <source>888</source>
                                </request>
                            </instance>
                            <instance id="response-calculate-rebuild" model-id="model">
                                <request>
                                    <value/>
                                    <value>888</value>
                                    <position>2</position>
                                    <source>888</source>
                                </request>
                            </instance>
                            <instance id="response-nocalculate-norebuild1" model-id="model">
                                <request>
                                    <value>42</value>
                                    <value/>
                                    <position>2</position>
                                    <source>888</source>
                                </request>
                            </instance>
                            <instance id="response-nocalculate-norebuild2" model-id="model">
                                <request>
                                    <value/>
                                    <value/>
                                    <position>2</position>
                                    <source>888</source>
                                </request>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Test xf:submission/@validate" name="oxf:pipeline">
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">

                        <xf:instance id="request">
                            <request/>
                        </xf:instance>

                        <xf:instance id="response-validate-norebuild">
                            <response>
                                <type/>
                                <type/>
                            </response>
                        </xf:instance>

                        <xf:instance id="response-validate-rebuild">
                            <response>
                                <type/>
                                <type/>
                            </response>
                        </xf:instance>

                        <xf:instance id="response-novalidate-norebuild1">
                            <response>
                                <type/>
                                <type/>
                            </response>
                        </xf:instance>

                        <xf:instance id="response-novalidate-norebuild2">
                            <response>
                                <type/>
                                <type/>
                            </response>
                        </xf:instance>

                        <xf:instance id="template" xxf:readonly="true">
                            <request>
                                <value/>
                                <value/>
                                <position>1</position>
                            </request>
                        </xf:instance>

                        <xf:bind ref="instance()/value[position() = instance()/position]" type="xf:integer"/>

                        <!-- Run submissions upon init -->
                        <xf:action ev:event="xforms-model-construct-done">
                            <xf:send submission="validate-norebuild"/>
                            <xf:send submission="validate-rebuild"/>
                            <xf:send submission="novalidate-norebuild1"/>
                            <xf:send submission="novalidate-norebuild2"/>
                            <!-- TODO: case of serialization="none" -->
                        </xf:action>

                        <xf:submission id="validate-norebuild" ref="instance()" method="post" resource="echo:"
                                           replace="none" validate="true" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state -->
                                <xf:insert ref="instance()" origin="instance('template')"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <xf:revalidate/>
                                <!-- setvalue: expecting just revalidate; integer type points to value[1] -->
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                            <xf:action ev:event="xforms-submit-done">
                                <xf:setvalue ref="instance('response-validate-norebuild')/type[1]" value="xxf:type(instance()/value[1])"/>
                                <xf:setvalue ref="instance('response-validate-norebuild')/type[2]" value="xxf:type(instance()/value[2])"/>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="validate-rebuild" ref="instance()" method="post" resource="echo:"
                                           replace="none" validate="true" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state but don't refresh -->
                                <xf:insert ref="instance()" origin="instance('template')"/>

                                <!-- Because of insert above, expecting: rebuild, revalidate; integer type points to value[2] -->
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                            <xf:action ev:event="xforms-submit-done">
                                <xf:setvalue ref="instance('response-validate-rebuild')/type[1]" value="xxf:type(instance()/value[1])"/>
                                <xf:setvalue ref="instance('response-validate-rebuild')/type[2]" value="xxf:type(instance()/value[2])"/>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="novalidate-norebuild1" ref="instance()" method="post" resource="echo:"
                                           replace="none" validate="false" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state -->
                                <xf:insert ref="instance()" origin="instance('template')"/>
                                <xf:rebuild/>
                                <xf:recalculate/>
                                <xf:revalidate/>
                                <!-- NOT expecting rebuild or revalidate, binds point to new instance -->
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                            <xf:action ev:event="xforms-submit-done">
                                <xf:setvalue ref="instance('response-novalidate-norebuild1')/type[1]" value="xxf:type(instance()/value[1])"/>
                                <xf:setvalue ref="instance('response-novalidate-norebuild1')/type[2]" value="xxf:type(instance()/value[2])"/>
                            </xf:action>
                        </xf:submission>

                        <xf:submission id="novalidate-norebuild2" ref="instance()" method="post" resource="echo:"
                                           replace="none" validate="false" relevant="false" xxf:calculate="false">

                            <xf:action ev:event="xforms-submit">
                                <!-- Restore state but don't refresh -->
                                <xf:insert ref="instance()" origin="instance('template')"/>

                                <!-- NOT expecting rebuild or revalidate, and binds point to old instance -->
                                <xf:setvalue ref="instance()/position">2</xf:setvalue>
                            </xf:action>
                            <xf:action ev:event="xforms-submit-done">
                                <xf:setvalue ref="instance('response-novalidate-norebuild2')/type[1]" value="xxf:type(instance()/value[1])"/>
                                <xf:setvalue ref="instance('response-novalidate-norebuild2')/type[2]" value="xxf:type(instance()/value[2])"/>
                            </xf:action>
                        </xf:submission>

                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="request" model-id="model">
                                <request>
                                    <value/>
                                    <value/>
                                    <position>2</position>
                                </request>
                            </instance>
                            <instance id="response-validate-norebuild" model-id="model">
                                <response>
                                    <type>integer</type>
                                    <type/>
                                </response>
                            </instance>
                            <instance id="response-validate-rebuild" model-id="model">
                                <response>
                                    <type/>
                                    <type>integer</type>
                                </response>
                            </instance>
                            <instance id="response-novalidate-norebuild1" model-id="model">
                                <response>
                                    <type>integer</type>
                                    <type/>
                                </response>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="oxf:xforms-submission with actions upon successful result" name="oxf:xforms-submission">
        <input name="submission">
            <xf:submission method="get" resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml">
                <!-- Try some actions -->
                <xf:action ev:event="xforms-submit-done">
                    <xf:insert ref="/*" origin="xxf:element('envelope', /*)"/>
                </xf:action>
            </xf:submission>
        </input>
        <input name="request">
            <dummy/>
        </input>
        <output name="response">
            <envelope>
                <book>
                    <title lang="en">Pale Blue Dot</title>
                    <author>Carl Sagan</author>
                </book>
            </envelope>
        </output>
    </test>

    <test description="oxf:xforms-submission with actions upon error result" name="oxf:xforms-submission">
        <input name="submission">
            <xf:submission method="get" resource="oxf:/ops/unit-tests/xforms-server/i-don't-exist.xml">
                <!-- Try some actions -->
                <xf:action ev:event="xforms-submit-done">
                    <xf:insert ref="/*" origin="xxf:element('success')"/>
                </xf:action>
                <xf:action ev:event="xforms-submit-error">
                    <xf:insert ref="/*" origin="xxf:element('failure')"/>
                </xf:action>
            </xf:submission>
        </input>
        <input name="request">
            <dummy/>
        </input>
        <output name="response">
            <failure/>
        </output>
    </test>

    <test description="xf:submit within XBL outer scope resolves submission" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=315509&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <!-- Simulate activation of submit button -->
                        <xf:dispatch ev:event="xforms-ready" name="DOMActivate" targetid="my-submit"/>
                        <xf:submission id="my-submission" method="get" resource="oxf:/ops/unit-tests/xforms-server/sample-instance.xml" replace="instance"/>
                    </xf:model>
                    <xbl:xbl>
                        <xbl:binding id="fr-foo" element="fr|foo">
                            <xbl:template>
                                <xbl:content/>
                            </xbl:template>
                        </xbl:binding>
                    </xbl:xbl>
                </xh:head>
                <xh:body>
                    <fr:foo id="my-foo">
                        <xf:submit id="my-submit" submission="my-submission"/>
                    </fr:foo>
                </xh:body>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance" model-id="model">
                                <book>
                                    <title lang="en">Pale Blue Dot</title>
                                    <author>Carl Sagan</author>
                                </book>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="Submission replace=&quot;all&quot; upon initialization with content response" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=306918&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-init.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:optimize-get-all="false">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:send ev:event="xforms-model-construct-done" submission="submission"/>
                        <xf:submission id="submission" serialization="none" method="get" action="oxf:/ops/unit-tests/test-data/book-diderot.xml"/>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <document xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="xs:base64Binary" content-type="application/xml">PGJvb2s+CiAgICA8ZGV0YWlscz4KICAgICAgICA8dGl0bGU+SmFjcXVlcyBsZSBmYXRhbGlzdGUg
ZXQgc29uIG1hw650cmU8L3RpdGxlPgogICAgICAgIDxhdXRob3I+RGVuaXMgRGlkZXJvdDwvYXV0
aG9yPgogICAgICAgIDxsYW5ndWFnZT5mcjwvbGFuZ3VhZ2U+CiAgICAgICAgPGxpbmsvPgogICAg
ICAgIDxyYXRpbmcvPgogICAgICAgIDxwdWJsaWNhdGlvbi15ZWFyLz4KICAgICAgICA8cmV2aWV3
Lz4KICAgICAgICA8aW1hZ2UgZmlsZW5hbWU9IiIgbWVkaWF0eXBlPSIiIHNpemU9IiIvPgogICAg
PC9kZXRhaWxzPgogICAgPG5vdGVzPgogICAgICAgIDxub3RlLz4KICAgIDwvbm90ZXM+CjwvYm9v<?orbeon-serializer flush?>
az4K</document>
        </output>
    </test>

    <test description="Submission replace=&quot;all&quot; upon initialization with redirect response" name="oxf:pipeline">
        <!-- See: http://forge.ow2.org/tracker/index.php?func=detail&aid=306918&group_id=168&atid=350207 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model" xxf:optimize-get-all="true">
                        <xf:instance id="instance">
                            <instance/>
                        </xf:instance>
                        <xf:send ev:event="xforms-model-construct-done" submission="submission"/>
                        <xf:submission id="submission" serialization="none" method="get" action="http://www.google.com/"/>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state/>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                    <xxf:load resource="http://www.google.com/" show="replace"/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>

    <test description="#122: Submission: XPath context is incorrect for xforms-submit handler" name="oxf:pipeline">
        <!-- See: https://github.com/orbeon/orbeon-forms/issues/122 -->
        <input name="config" href="wrap-xforms-state.xpl"/>
        <input name="document">
            <xh:html>
                <xh:head>
                    <xf:model id="model">
                        <xf:instance id="instance1">
                            <value/>
                        </xf:instance>
                        <xf:instance id="instance2">
                            <value/>
                        </xf:instance>
                        <xf:send ev:event="xforms-model-construct-done" submission="submission"/>
                        <xf:submission ref="instance('instance2')" id="submission" method="post" action="echo:" replace="none">
                            <xf:setvalue ev:event="xforms-submit" ref="." value="42"/>
                        </xf:submission>
                    </xf:model>
                </xh:head>
            </xh:html>
        </input>
        <output name="response">
            <xxf:event-response>
                <xxf:dynamic-state>
                    <dynamic-state>
                        <instances>
                            <instance id="instance2" model-id="model">
                                <value>42</value>
                            </instance>
                        </instances>
                    </dynamic-state>
                </xxf:dynamic-state>
                <xxf:action>
                    <xxf:control-values/>
                </xxf:action>
            </xxf:event-response>
        </output>
    </test>


</group>
